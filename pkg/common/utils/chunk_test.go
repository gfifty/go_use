/*
 * Copyright 2022 CloudWeGo Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package utils

import (
	"strings"
	"testing"

	"github.com/cloudwego/hertz/pkg/common/test/assert"
	"github.com/cloudwego/hertz/pkg/common/test/mock"
)

func TestChunkParseChunkSizeGetCorrect(t *testing.T) {
	// iterate the hexMap, and judge the difference between dec and ParseChunkSize
	hexMap := map[int]string{0: "0", 10: "a", 100: "64", 1000: "3e8"}
	for dec, hex := range hexMap {
		chunkSizeBody := hex + "\r\n"
		zr := mock.NewZeroCopyReader(chunkSizeBody)
		chunkSize, err := ParseChunkSize(zr)
		assert.DeepEqual(t, nil, err)
		assert.DeepEqual(t, chunkSize, dec)
	}
}

func TestChunkParseChunk(t *testing.T) {
	// test the whitespace
	whiteSpace := "5bf2\r\n<!doctype html><html class=\"notranslate\"><head><meta charset=\"UTF-8\"/><meta name=\"viewport\" content=\"width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1\"/><meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"/><meta name=\"google\" value=\"notranslate\"/><meta name=\"sheet-data-version\" content=\"8\"/><meta name=\"renderer\" content=\"webkit\"/><meta property=\"og:image\" content=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/feishu.ico\"><script>window.gfdatav1={\"env\":\"boe\",\"ver\":\"1.0.0.3029\",\"canary\":0,\"garrModules\":null,\"envName\":\"\",\"region\":\"BOE\",\"extra\":{\"canaryType\":null}}</script><script>window.parseStartTime=Date.now(),window.serverSsrStartTime=\"1690962474607\";</script><style>body,html{margin:0;padding:0;height:100%}#mainBox{height:calc(var(--vh,1vh) * 100);width:100vw;background:var(--bg-body)}</style><title>Docs</title><script>!function(){function isLocalHost(){var o=window.location;return o.host.indexOf(\"localhost\")>-1||/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+):(\\d+)$/.test(o.host)}if(isLocalHost())try{var xhrObj=new XMLHttpRequest;xhrObj.open(\"GET\",\"/js/only_dev.js\",!1),xhrObj.send(\"\"),eval(xhrObj.responseText)}catch(o){console.log(o)}}();</script><script>window.langCdns = {\"fileNames\":{\"de-DE\":\"de-DE.2b30066b998f67f1.js\",\"en-US\":\"en-US.d074f52331407176.js\",\"es-ES\":\"es-ES.82c9358573fb9c90.js\",\"fr-FR\":\"fr-FR.37c6e9494a6dfdb1.js\",\"hi-IN\":\"hi-IN.3a690c5c2082cbee.js\",\"id-ID\":\"id-ID.372d6f2036266f6b.js\",\"it-IT\":\"it-IT.0587fc924ea8938f.js\",\"ja-JP\":\"ja-JP.97aa3c6d8271bcbc.js\",\"ko-KR\":\"ko-KR.03ed50f883471b15.js\",\"pt-BR\":\"pt-BR.2430287ef929832f.js\",\"ru-RU\":\"ru-RU.111e1b5fdffd499e.js\",\"th-TH\":\"th-TH.1fb5503cc6a10c7d.js\",\"vi-VN\":\"vi-VN.043fc65edf15c5bb.js\",\"zh-CN\":\"zh-CN.6cdaaf82359dcac3.js\",\"zh-HK\":\"zh-HK.09e6826c04c07cd6.js\",\"zh-TW\":\"zh-TW.6f9b107a7d5d3e5e.js\"},\"pathPrefix\":\"/ccm/pc/web/resource/bear/lang/\"}</script><script>window.baseLangCdns = {\"fileNames\":{\"de-DE\":\"de-DE.53f894eef7f14503.js\",\"en-US\":\"en-US.dab75bae6197aba8.js\",\"es-ES\":\"es-ES.7a4bb81db24b745b.js\",\"fr-FR\":\"fr-FR.45a63afb11917c62.js\",\"hi-IN\":\"hi-IN.86cb8b609e9e19ae.js\",\"id-ID\":\"id-ID.fb26d7f48919d9c1.js\",\"it-IT\":\"it-IT.0f0e7c229383e4d9.js\",\"ja-JP\":\"ja-JP.2a3821e3913e55c4.js\",\"ko-KR\":\"ko-KR.dd90cbb58b80166d.js\",\"pt-BR\":\"pt-BR.b5d7c36c90590fee.js\",\"ru-RU\":\"ru-RU.96b8ca0460774569.js\",\"th-TH\":\"th-TH.9384c57e90b1d88b.js\",\"vi-VN\":\"vi-VN.5076dddb1593c248.js\",\"zh-CN\":\"zh-CN.fd4e1e33309b1b80.js\",\"zh-HK\":\"zh-HK.3bf99f98f45278a0.js\",\"zh-TW\":\"zh-TW.c4186f96e2313958.js\"},\"pathPrefix\":\"/ccm/pc/web/resource/bear/lang/\"}</script><script>!function(){function e(){var e={map:new Map,clear:()=>(e.length=0,e.map.clear()),setItem(t,n){e.map.set(t,n),e.length++},getItem:t=>e.map.get(t),removeItem(t){e.map.delete(t),e.length--},key:t=>Array.from(e.map.keys())[t]||\"\",length:0};return e}var t=e(),n=e();try{console.log(window.localStorage.length)}catch(e){Object.defineProperty(window,\"localStorage\",{get:function(){return t}}),Object.defineProperty(window,\"sessionStorage\",{get:function(){return n}})}}();</script><script>window.scm={version:\"1.0.11.6053\",type:\"online\",branch:\"release-web-2023.7.4\",tpl:\"pc_index_dox_mpa_chunked.html\"},window.rv_rev=\"docs-7-31-1690771092954\",window.pkgScm={block:{version:\"3.90.10\",scm:\"\",branch:\"\"},editor:{version:\"3.90.10\",scm:\"\",branch:\"\"}};</script><script>window.globalConfig=Object({\"common\":{\"abTest\":{\"ab_channel_domain\":\"https://abtestvm.bytedance.com\"},\"brand\":{\"app_name\":\"APP_NAME_FEISHU\"},\"channel\":\"saas\",\"domain\":{\"applink\":\"applink.feishu-boe.cn\",\"dlp_api\":\"internal-api-security.feishu-boe.cn\",\"helpcenter\":\"www.feishu-boe.cn\",\"helpdesk\":\"helpdesk.feishu-boe.cn\",\"lark_api\":\"internal-api-lark-api.feishu-boe.cn\",\"lark_file\":\"internal-api-lark-file.feishu-boe.cn\",\"lark_survey\":\"wenjuan.feishu-boe.cn\",\"official\":\"www.feishu-boe.cn\",\"okr_api\":\"okr.feishu-boe.cn\",\"open\":\"open.feishu-boe.cn\",\"open_platform\":\"internal-api.feishu-boe.cn\",\"open_tpl_service\":\"blockit-template-service.boe.goofy.app\",\"passport\":\"login.feishu-boe.cn\",\"passport_agw_feishu\":\"login.feishu-boe.cn\",\"passport_agw_lark\":\"passport.larksuite-boe.com\",\"security\":\"internal-api.feishu-boe.cn\",\"setting\":\"internal-api-lark-api.feishu-boe.cn\"},\"domainPool\":[\"docs.bytedance.net\",\"feishu-boe.net\",\"feishu-boe.cn\",\"larksuite-boe.com\"],\"env\":\"boe\",\"frontier\":{\"aid\":1191,\"appKey\":\"5a4d135f57bfbf0461ad10cc7f1d3658\",\"fpid\":54},\"garrMina\":{\"appId\":60,\"domain\":\"open.feishu-boe.cn\",\"pathName\":\"/config/get\",\"version\":\"1.0.0\"},\"helpcenter_article\":{\"app_share_help\":360049067873,\"authorized_help\":360025093793,\"confluence_importing_help\":612602911143,\"importing_help\":360026428074,\"incompatible_extension\":360037376033,\"shimo_importing_help\":\"049570101480\",\"space_single_container\":361321970830,\"stickup_help\":360044875193,\"storage_help\":360049067797,\"supported_browser\":360038713913},\"i18nCdnApi\":{\"domain\":\"starling.snssdk.com\",\"path\":\"/get_cdn/2102/\"},\"landingDomain\":\"www.feishu-boe.cn\",\"mainDomain\":\"feishu-boe.cn\",\"metrics\":{\"domain\":\"api.zjurl.cn\",\"open\":true},\"mina\":{\"appId\":2,\"domain\":\"open.feishu-boe.cn\",\"pathName\":\"/config/get\",\"version\":\"staging-1.0\"},\"product\":\"feishu\",\"rosetta\":{\"domain\":\"rosetta.feishu.cn\",\"path\":\"/rosetta/api/v1/products/29/cdn\"},\"secLink\":{\"appId\":2234,\"open\":true},\"sentry\":{\"domain\":\"ee-sentry.byted.org\",\"mobile\":{\"domain\":\"ee-sentry.byted.org\",\"open\":true,\"organizationSlug\":\"bytedance-ee\",\"projectSlug\":{\"doc\":\"bear_mobile\"},\"raven\":{\"dsnDomain\":\"b2b4fd03e1c94c17bdfee04f4001d617@internal-api-sentry.feishu.cn/normal\",\"ignoreUrls\":[\"bear-test\\\\.bytedance\\\\.net\",\"docs-test\\\\.bytedance\\\\.net\"],\"logger\":\"docs-mobile\",\"projectId\":267}},\"open\":true,\"organizationSlug\":\"bytedance-ee\",\"projectSlug\":{\"doc\":\"bear_fe\"},\"raven\":{\"bid\":{\"docs_pc\":\"docs_pc\"},\"dsnDomain\":\"f60ebb5d980b4795ad10d8ca7259dc0e@internal-api-sentry.feishu.cn/normal\",\"ignoreUrls\":[\"bear-test\\\\.bytedance\\\\.net\"],\"logger\":{\"doc\":\"docs-fe\"},\"projectId\":{\"doc\":65}}},\"slardar\":{\"config\":{\"bid\":{\"docs_pc\":\"docs_pc\"},\"ignoreAjax\":[\"mcs\\\\.snssdk\\\\.com\",\"mcs-bd\\\\.feishu\\\\.cn\",\"mon-va\\\\.byteoversea\\\\.com\",\"api\\\\.zjurl\\\\.cn\",\".*api\\\\/sheet\\\\/sht.*\"]},\"domain\":\"slardar.bytedance.net\",\"logDomain\":\"slardar-bd.feishu.cn\",\"mobile\":{\"config\":{\"bid\":\"docs_mobile\",\"ignoreAjax\":[\"mcs\\\\.snssdk\\\\.com\",\"mcs-bd\\\\.feishu\\\\.cn\"],\"pid\":\"index\"},\"domain\":\"slardar.bytedance.net\",\"logDomain\":\"slardar-bd.feishu.cn\",\"open\":true,\"region\":\"cn\",\"sdkAddr\":\"https://lf3-cdn-tos.bytegoofy.com/goofy/slardar/fe/sdk/browser.cn.js\"},\"open\":true,\"region\":\"cn\",\"sdkAddr\":\"https://lf3-cdn-tos.bytegoofy.com/goofy/slardar/fe/sdk/browser.cn.js\"},\"slardarWeb\":{\"bid\":\"docs_pc\",\"ignoreUrls\":[\"mcs\\\\.snssdk\\\\.com\",\"maliva-mcs\\\\.byteoversea\\\\.com\",\"mon-va\\\\.byteoversea\\\\.com\",\"api\\\\.zjurl\\\\.cn\",\".*api\\\\/sheet\\\\/sht.*\",\"mcs-bd.*\",\"slardar-bd.*\"],\"open\":true,\"sdkAddr\":\"https://lf3-short.ibytedapm.com/slardar/fe/sdk-web/browser.cn.js\"},\"tea\":{\"api\":{\"report\":\"/v1/list\"},\"config\":{\"appId\":{\"doc\":1229,\"drive_sdk\":2331,\"single_product\":2916},\"channel_domain\":\"https://mcs-bd.feishu.cn\"},\"domain\":\"data.bytedance.net/tea\",\"open\":true,\"productId\":{\"doc\":40},\"report_default_domain\":\"mcs-bd.feishu.cn\"},\"unit\":\"boecn\"},\"drive_api\":[\"internal-api-drive-stream.feishu-boe.cn\"],\"drive_bgp_api\":[\"https://internal-api.feishu-boe.cn\"],\"drive_bgp_stream\":[\"https://internal-api-drive-stream.feishu-boe.cn\"],\"drive_bgp_weboffice\":[\"http://box-boe.bytedance.net:30081\"],\"ext\":{\"domain\":{\"helpcenter\":\"www.feishu-boe.cn\",\"helpdesk\":\"helpdesk.feishu-boe.cn\",\"internal-api\":\"internal-api.feishu-boe.cn\",\"lark_api\":\"internal-api-lark-api.feishu-boe.cn\",\"lark_file\":\"internal-api-lark-file.feishu-boe.cn\",\"mina\":\"open.feishu-boe.cn\",\"official\":\"www.feishu-boe.cn\",\"passport\":\"login.feishu-boe.cn\"},\"helpcenter_article\":{\"incompatible_extension\":360037376033},\"pathname\":{\"mina\":\"/config/get\"}},\"frontier\":[\"ccm-platform-frontier.bytedance.net\"],\"image\":[\"p3-space-ee.byteimg.com\",\"p1-space-ee.byteimg.com\"],\"internal_api\":[\"https://internal-api.feishu-boe.cn\"],\"nearby_drive_api\":[\"internal-api-drive-stream-lf.feishu-boe.cn\",\"internal-api-drive-stream-hl.feishu-boe.cn\"],\"overload_static_domain\":[\"sf3-scmcdn2-cn.feishucdn.com\",\"sf6-scmcdn2-cn.feishucdn.com\"],\"paramsConfig\":{\"create_api\":[\"internal-api.feishu-boe.cn/space/api/explorer/create\",\"internal-api.larksuite-boe.com/space/api/explorer/create\"],\"fileSecureMode\":false,\"fileURLPrefix\":\"https://www.feishu-boe.cn\",\"fileWebOfficeDomain\":\"box-boe.bytedance.net\",\"storageNullSecretKey\":\"4c6ad794909459e358c959d830fe7940\",\"unitID\":\"boecn\",\"updatePreviewTplSeed\":1},\"space_api\":[\"internal-api-space-backup.feishu-boe.cn\",\"internal-api-space.feishu-boe.cn\"],\"urlMapper\":{\"docHome\":\"https://www.feishu-boe.cn/drive/home/\",\"downloadLark\":\"https://www.feishu-boe.cn/download\",\"larkHome\":\"https://www.feishu-boe.cn/\",\"loginDocs\":\"https://login.feishu-boe.cn/docs/passport/page/login\",\"loginLark\":\"https://login.feishu-boe.cn/suite/passport/page/login\",\"singleDocsHome\":\"https://docs.feishu-boe.cn/\",\"wikiHome\":\"https://www.feishu-boe.cn/wiki/\"}}); window.templateRequestInfo = window.templateRequestInfo || {}; var encryptedToken = 'f9818a5039b0d50c804d48917d34a5a04c26f545'; if (encryptedToken) { window.templateRequestInfo.encryptedToken = encryptedToken; } var logId = '20230802154754AB571C0CE462012E9C2B'; if (logId) { window.templateRequestInfo.logId = logId; }</script><script>!function(){var r=!1;function e(r){var e=\"\",n=\"\",t=window.globalConfig.overload_static_domain;if(t&&t.length>0)for(var o=0;o<t.length;o++){var i=r.split(t[o]);if(i.length>1){n=i[1],e=t[o];break}}return{host:e,pathname:n}}function n(r,n,t,i,c,d){var a=document.createElement(r);const _=!i;_&&(document.head.appendChild(a),window.logCheckReactVersion(\"genTargetElement append script \"+n));var s=window.extractChunkIdWithSrc(n);switch(window.logCDNErrorEntries(s,r,{add_cdn_error_retry_times:1,startTime:Date.now()}),a.onload=function(e){window.logCDNErrorEntries(s,r,{add_cdn_error_retry_times:1}),window.logCDNErrorRetrySuccessEntries(s,r);var i=r+\"-\"+s;o(\"client_cdn_retry_success\",{src:n,tagName:r,duration:window.__cdnErrorEntries__&&window.__cdnErrorEntries__[i]&&Date.now()-window.__cdnErrorEntries__[i].startTime}),window.removeCDNErrorEntry(s,r),t(e)},r){case\"script\":a.src=n;break;case\"link\":a.rel=\"stylesheet\",a.href=n}return a.onerror=function(o){window.logCDNErrorEntries(s,r,{add_cdn_error_times:1,add_error_domain:e(n).host,endTime:Date.now()}),window.staticCDNErrorHandler(a.src||a.href,r),window.tryToLoadBackupCdn(a.src||a.href,r,_,t,c,d)},a}function t(r,e){var n=window.collectEvent||window.htmlCollectEvent;n&&n(r,e)}function o(r,e){t(r,{path:location.pathname.replace(/\\/([a-zA-Z0-9]+)$/,\"/:token\"),src:e.src,tagName:e.tagName,type:e.type,retry_times:e.retry_times,duration:e.duration,app_js_loaded:window.collectEvent?\"true\":\"false\",networkStatus:navigator.onLine?\"online\":\"offline\",template_log_id:window.templateRequestInfo&&window.templateRequestInfo.logId})}function i(r){var e={},n=r.requestStart,t=(r.requestEnd,r.responseStart),o=r.responseEnd;return e.domainLookupTime=r.domainLookupEnd-r.domainLookupStart,e.connectTime=r.connectEnd-r.connectStart,e.TTFBTime=t-n,e.requestTime=0===n?0:o-n,0!==r.secureConnectionStart&&(e.SSLTime=r.connectEnd-r.secureConnectionStart),e.usedTime=o-r.fetchStart,e}window.getBackupCdn=function(r){r||(r=1);var e=window.globalConfig.overload_static_domain;return e[r%e.length]},window.getBackupURL=function(r,n){var t=e(r).host;return t?r.replace(new RegExp(t),getBackupCdn(n)):r},window.logCheckReactVersion=function(r){try{window.__checkReactVersionLog__||(window.__checkReactVersionLog__=[]);var e=(location.pathname.match(/\\/([a-zA-Z0-9]+)$/)||[])[0],n=String(Error(r).stack),t=e?n.replace(new RegExp(e,\"g\"),\"/:token\"):n,o=Error.stackTraceLimit;Error.stackTraceLimit=1/0,window.__checkReactVersionLog__.push((new Date).toISOString()+\" \"+t),Error.stackTraceLimit=o,window.__checkReactVersionLog__.length>50&&window.__checkReactVersionLog__.shift()}catch(r){console.error(\"logCheckReactVersion\",r)}},window.logCDNErrorEntries=function(r,e,n){try{if(window.__cdnErrorEntries__||(window.__cdnErrorEntries__={}),!r)return;n||(n={});var t=window.__cdnErrorEntries__,o=e+\"-\"+r;if(!t[o]){var i=n.first_fetch_duration;void 0===i&&(i=Date.now()-performance.timing.responseEnd),t[o]={first_fetch_duration:i,cdn_error_times:1,cdn_error_retry_times:0,error_domains:[]}}n.add_cdn_error_times&&(t[o].cdn_error_times+=n.add_cdn_error_times),n.add_cdn_error_retry_times&&(t[o].cdn_error_retry_times+=n.add_cdn_error_retry_times),n.add_error_domain&&t[o].error_domains.push(n.add_error_domain),n.startTime&&(t[o].startTime=n.startTime),n.endTime&&(t[o].endTime=n.endTime)}catch(r){console.error(\"logCDNErrorEntries\",r)}},window.removeCDNErrorEntry=function(r,e){try{var n=e+\"-\"+r;window.__cdnErrorEntries__[n]=null}catch(r){console.error(\"removeCDNErrorEntry\",r)}},window.logCDNErrorRetrySuccessEntries=function(r,e,n){try{if(!r||!e)return;var t=e+\"-\"+r;if(!window.__cdnErrorEntries__||!window.__cdnErrorEntries__[t])return;window.__cdnErrorRetrySuccessEntries__||(window.__cdnErrorRetrySuccessEntries__=[]),window.__cdnErrorRetrySuccessEntries__.push(t)}catch(r){console.error(\"logCDNErrorRetrySuccessEntries\",r)}},window.extractChunkIdWithSrc=function(r){try{return r.match(/(\\w+)[\\.|_][\\w|\\[|\\]\\-]+.(js|css)/)[1]}catch(e){console.error(\"extractChunkIdWithSrc\",e,r)}},window.staticCDNErrorHandler=function(n,o,c,d){var a=window.extractChunkIdWithSrc(n);window.logCDNErrorEntries(a,o),window.logCheckReactVersion(\"staticCDNErrorHandler \"+n),c&&window.tryToLoadBackupCdn(n,o,!1,d,c.target.parentNode),!r&&performance&&performance.getEntries&&(r=!0,setTimeout(()=>{t(\"client_resources_loaded_time_when_cdn_error\",function(){for(var r,n={},t=0,o=performance.getEntries(),c=o.length,d=performance.now(),a=c;a--;){var _=o[a];if(d-_.fetchStart>6e5)break;var s=_.initiatorType;if(\"script\"===s||\"link\"===s){var w=e(_.name);if(w){n[m=w.host]||(n[m]={length:0,encodedBodySize:0});var u=n[m],l=i(_);for(var E in u.length++,u.encodedBodySize+=_.encodedBodySize,l)void 0===u[E]&&(u[E]=0),u[E]+=l[E];l.usedTime>t&&(t=l.usedTime,r=_)}}}for(var m in n){var h=n[m],f=h.length;for(var g in h){if(\"length\"===g)break;h[g]/=f}}if(r){var p=i(r);p.encodedBodySize=r.encodedBodySize,p.timestamp=r.fetchStart,n.maxResourceLoadedTime=p}return n}())},2e3))},window.tryToLoadBackupCdn=function(r,e,t,i,c,d){try{var a=e+\"-\"+window.extractChunkIdWithSrc(r);o(\"cdn_error_handle\",{src:r,type:t?\"chunk\":\"normal\",retry_times:window.__cdnErrorEntries__&&window.__cdnErrorEntries__[a]&&window.__cdnErrorEntries__[a].cdn_error_retry_times,duration:window.__cdnErrorEntries__&&window.__cdnErrorEntries__[a]&&window.__cdnErrorEntries__[a].endTime-window.__cdnErrorEntries__[a].startTime});var _=window.globalConfig.overload_static_domain;if(!_||!_.length)return s(),!1;var s=i||function(){};if(d||(d=1),d>3)return o(\"client_cdn_error\",{src:r,tagName:e}),s(),!1;if(t)var w=n(e,getBackupURL(r,d),s,!1,c,d+1);else{w=n(e,getBackupURL(r,d),s,!0,c,d+1);c?c.appendChild(w):document.head.appendChild(w),window.logCheckReactVersion(\"tryToLoadBackupCdn append script \"+getBackupURL(r,d))}}catch(r){console.error(r)}}}();</script><link rel=\"preload\" href=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/ccm_theme_token.91a892d9649967c31ad4.js\" as=\"script\"><link rel=\"preload\" href=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/doc_index_css.74db0b61b32e71c5c1aa.js\" as=\"script\"><link rel=\"preload\" href=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/docx_app_next.a561afb7dbdb9e2eb0be.js\" as=\"script\"><script>!function(){if(window.location.search.indexOf(\"from=\")>-1){for(var e,t,o=/from=([^&]*)/g;null!==(e=o.exec(window.location.search));)t=e[1];window.sessionStorage.setItem(\"__ENTER_FROM__\",t),t.startsWith(\"lark.\")&&/lark/i.test(navigator.userAgent)&&(window.notTryToReloadCdn=!0)}var n=/windows|win32/i.test(navigator.userAgent),a=/LKPDesktop/i.test(navigator.userAgent),s=document.querySelector(\"html\");n&&(s.className+=\" windows\"),a&&(s.className+=\" lkp\")}();</script><script>!function(){var t;function n(){var t=.01*window.innerHeight;document.documentElement.style.setProperty(\"--vh\",t+\"px\")}t=navigator.userAgent,(/iPad/i.test(t)||function(t,n){return!!(n.maxTouchPoints&&n.maxTouchPoints>2&&/Macintosh/.test(t)&&/MacIntel/.test(n.platform||\"\"))}(t,navigator))&&(n(),window.addEventListener(\"resize\",()=>{n()}))}();</script><script>window.staticCDNErrorHandler||console.error(\"not found staticCDNErrorHandler in window\"),window.cssDownloadStartTime=Date.now();</script><link href=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/css/doc_index_css.ea068fc13a4311daf843.css\" onerror='staticCDNErrorHandler(\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/css/doc_index_css.ea068fc13a4311daf843.css\",\"link\",event);' rel=\"stylesheet\"/><link href=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/css/docx_app_next.6b76b879f630b678ccdb.css\" onerror='staticCDNErrorHandler(\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/css/docx_app_next.6b76b879f630b678ccdb.css\",\"link\",event);' rel=\"stylesheet\"/><script>window.cssDownloadEndTime=Date.now();</script><script src=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/ccm_theme_token.91a892d9649967c31ad4.js\" onerror='staticCDNErrorHandler(\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/ccm_theme_token.91a892d9649967c31ad4.js\",\"script\",event);'></script><script src=\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/doc_index_css.74db0b61b32e71c5c1aa.js\" onerror='staticCDNErrorHandler(\"//sf3-scmcdn2-cn.feishucdn.com/ccm/pc/web/resource/bear/js/doc_index_css.74db0b61b32e71c5c1aa.js\",\"script\",event);'></script><script>!function(){function e(e,n){for(var o=n.split(\".\"),a=e,t=0;t<o.length&&null!=a;t++)a=a[o[t]];return a}function n(){const n=e(window,\"navigator.userAgent\");var o=n?n.match(/Chrome|Safari|Firefox|Opera/i):\"\";return o?o[0]:\"\"}function o(n){var o=window.location;const a=e(window,\"navigator.userAgent\");var t,i=(window.name||\"\").startsWith(\"MESSAGE_CHANNEL\");return n.isFeishu=/feishu/i.test(a),n.isLark=n.isFeishu||/lark/i.test(a),n.isFeishuRooms=/FeishuRooms|LarkRooms/i.test(a),n.isInVC=/vc=true/.test((o.search||\"\").toLowerCase())||n.isLark&&/\\sVC\\//.test(a),n.isOpendoc=/opendoc=(true|1)/.test((o.search||\"\").toLowerCase())||/^\\/component\\//.test(o.pathname||\"\"),n.isFeed=/Feed/i.test(a)||/lark=1/.test(o.search)||/sourceType=feed/.test(o.search),n.isMultiPage=n.isLark&&/multiPage=1/.test(o.search),n.isFromSuperApp=n.isLark&&/superapp/i.test(a)&&!window.larkTabName,n.isFeishuRooms?\"VC Room\":n.isInVC?\"VC\":n.isOpendoc?i?\"opendoc_applet\":\"opendoc\":i?\"applet\":n.isMultiPage?\"docs_im_container_scene\":n.isFeed?\"docs-feed\":n.isFromSuperApp?\"docs_im_container_scene_v2\":window.parent!==window?\"iframe\":((t=window.location.search.substr(1).match(/(^|&)scene=([^&]*)(&|$)/i))?decodeURIComponent(t[2]).toLowerCase():\"\")||\"web\"}window.htmlCollectEvent=function(a,t,i,r){if(!(window.matchTeaSample?window.matchTeaSample(a):function(n){try{const o=(e(window,\"User.clientFeatures\")||{})[\"ccm.tea_sample\"]||!1;if(!o)return!1;const a=o?JSON.parse(o):{},t=a.hasOwnProperty(\"default\")?a.default:1,i=window.localStorage.getItem(\"sampleUserId\"),r=a.hasOwnProperty(n)?a[n]:t;if(i%1e4>=1e4*r)return!0}catch(e){console.error(\"teaSample error\",e)}return!1}(a))){var s,c=\"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\";(t=t||{}).branch||(t.branch=window.scm&&window.scm.branch||\"\"),void 0===t._staging_flag&&(t._staging_flag=!e(window,\"local.isE2E\")&&(s=e(window,\"globalConfig.common.env\"),function(){var e=window.location;return e.host.indexOf(\"localhost\")>-1||/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+):(\\d+)$/.test(e.host)}()||\"online\"!==s&&\"pre_release\"!==s)?1:0),t.path||(t.path=location.pathname.replace(/\\/([a-zA-Z0-9]+)$/,\"/:token\"));var d=e(window,\"globalConfig.common.tea\"),w={};if(d&&d.open){var p,m=\"saas\"===e(window,\"globalConfig.common.channel\"),u=e(window,\"User.settingsConfig.ccm_platform_tea_config.mg_tea_domain\"),l=e(window,\"User.settingsConfig.ccm_platform_tea_config.mg_app_id\"),_=m&&u&&l,h=_?u:d.config.channel_domain,g=_?l:d.config.appId.doc;if(!t.file_id){var f=e(window,\"templateRequestInfo.encryptedToken\");f&&(t.file_id=f)}try{p=e(window,\"User.encryptedUserId\")||window.localStorage.getItem(\"userUniqueId\")}catch(e){}p||(p=c);var x=window.rv_rev,v=\"\",b=\"\";if(x){var C=x.split(\"-\");v=C[1]+\"-\"+C[2],b=C[3]}var y=e(window,\"User.abTest.versions\"),S=\"\";y&&y.length>0&&(S=y[0].version_name);var k=e(window,\"anonymousAccess.isAnonymousAccess\")?\"anonymous\":\"suite\",F=[{user:{user_unique_id:p,ssid:\"____\"},header:{ab_version:S,app_id:g,__userless:\"true\",app_language:e(window,\"User.language\"),browser:n()},events:[{event:a,local_time_ms:Date.now(),params:JSON.stringify(t)}]}];F.forEach((function(n,a){if(F[a].header.headers={custom:{web_version_date:v,web_version_timestamp:b,web_version:e(window,\"scm.version\"),web_branch:e(window,\"scm.branch\"),gray_scale:\"ga\"===e(window,\"bearGarr.stageName\")?\"master\":e(window,\"scm.branch\"),stage_name:e(window,\"bearGarr.stageName\"),stage_description:e(window,\"bearGarr.stageDescription\"),brand:e(window,\"globalConfig.common.product\"),tenant_id:e(r,\"tenant_id\")||e(window,\"User.encryptedTenantId\")||c,user_type:k,app_form:o(w),lark_user_id:p}},function(){const n=e(window,\"navigator.userAgent\");return/feishu/i.test(n)||/lark/i.test(n)}()){const e=window.webContainer&&window.webContainer.type||w.isFromSuperApp&&\"superapp_webview\"||\"\";e&&(F[a].header.headers.custom.docs_lark_container_type=e)}var t;/scene_id/.test(location.search)&&(F[a].header.headers.custom.doc_component_scene_id=((t=window.location.search.substr(1).match(/(^|&)scene_id=([^&]*)(&|$)/i))?decodeURIComponent(t[2]).toLowerCase():\"\")||\"none\")})),window.uaJudge&&1===window.uaJudge.supportHigh&&F.forEach((function(e,n){F[n].header.headers.custom.js_version=1})),F.forEach((function(e,n){F[n].header.headers=JSON.stringify(F[n].header.headers)}));var A=JSON.stringify(F);if(i)navigator.sendBeacon&&navigator.sendBeacon(h+d.api.report,A);else{var I=new XMLHttpRequest;I.open(\"post\",h+d.api.report),I.send(A)}}}}}();</script> <style id=\"watermarkSSRStyle\">.ssrWaterMark{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:99}</style><script>!function(){var e=document.querySelector(\"#watermarkSSRStyle\");if(e){var t=navigator.userAgent;(/vcWaterMark=1/i.test(location.search)&&(/FeishuRooms|LarkRooms/i.test(t)||/VC\\/\\d+\\.\\d+\\.\\d+[^ ]* Apollyon\\/\\d+/i.test(t)||/IronWebview\\//.test(t))||/shwm=true/i.test(location.search))&&(e.innerHTML+=\".ssrWaterMark { display: none; }\")}}();</script><script>window.handleChunkError=(a,n)=>{const e=new URLSearchParams(location.search);e.set(\"chunked\",\"false\"),location.search=e.toString()};</script><script>window.addEventListener(\"load\",(function(){const n={firstChunkSent:!!window.firstChunkEndTime,secondChunkSent:!!window.secondChunkStartTime,thirdChunkSent:!!window.thirdChunkStartTime,template_log_id:window.templateRequestInfo&&window.templateRequestInfo.logId};if(window.htmlCollectEvent&&window.htmlCollectEvent(\"chunk_render_stage_dev\",{isChunkedRender:window.isChunkedRender,...n}),window.isChunkedRender){window.firstChunkEndTime&&window.secondChunkStartTime&&window.thirdChunkStartTime||(htmlCollectEvent&&htmlCollectEvent(\"chunk_render_error_dev\",n),window.handleChunkError&&window.handleChunkError())}})),window.ms&&window.ms.log&&window.ms.log(\"event: first chunk load, \"+window.templateRequestInfo.logId);</script><script>window.isChunkedRender=!0,window.firstChunkEndTime=Date.now();</script>  "

	zr := mock.NewZeroCopyReader(whiteSpace)
	chunkSize, err := ParseChunkSize(zr)
	assert.DeepEqual(t, nil, err)
	assert.DeepEqual(t, 23538, chunkSize)

	buf, err := zr.Peek(23538)
	assert.Nil(t, err)
	assert.True(t, strings.Contains(whiteSpace, string(buf)))
}

func TestChunkParseChunkSizeCorrectWhiteSpace(t *testing.T) {
	// test the whitespace
	whiteSpace := ""
	for i := 0; i < 10; i++ {
		whiteSpace += " "
		chunkSizeBody := "0" + whiteSpace + "\r\n"
		zr := mock.NewZeroCopyReader(chunkSizeBody)
		chunkSize, err := ParseChunkSize(zr)
		assert.DeepEqual(t, nil, err)
		assert.DeepEqual(t, 0, chunkSize)
	}
}

func TestChunkParseChunkSizeNonCRLF(t *testing.T) {
	// test non-"\r\n"
	chunkSizeBody := "0" + "\n\r"
	zr := mock.NewZeroCopyReader(chunkSizeBody)
	chunkSize, err := ParseChunkSize(zr)
	assert.DeepEqual(t, true, err != nil)
	assert.DeepEqual(t, -1, chunkSize)
}

func TestChunkReadTrueCRLF(t *testing.T) {
	CRLF := "\r\n"
	zr := mock.NewZeroCopyReader(CRLF)
	err := SkipCRLF(zr)
	assert.DeepEqual(t, nil, err)
}

func TestChunkReadFalseCRLF(t *testing.T) {
	CRLF := "\n\r"
	zr := mock.NewZeroCopyReader(CRLF)
	err := SkipCRLF(zr)
	assert.DeepEqual(t, errBrokenChunk, err)
}
